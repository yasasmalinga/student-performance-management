<div class="dashboard-container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo-placeholder">LOGO</div>
      <h3>Student Portal</h3>
    </div>
    
    <nav class="sidebar-nav">
      <a class="nav-item" [class.active]="activeView === 'dashboard'" (click)="switchView('dashboard')">
        <span class="nav-icon">📊</span>
        <span>Dashboard</span>
      </a>
      <a class="nav-item" [class.active]="activeView === 'performance'" (click)="switchView('performance')">
        <span class="nav-icon">📈</span>
        <span>My Performance</span>
      </a>
      <a class="nav-item" [class.active]="activeView === 'tests'" (click)="switchView('tests')">
        <span class="nav-icon">📝</span>
        <span>Tests & Results</span>
      </a>
      <a class="nav-item" [class.active]="activeView === 'attendance'" (click)="switchView('attendance')">
        <span class="nav-icon">📅</span>
        <span>Attendance</span>
      </a>
      <a class="nav-item" [class.active]="activeView === 'subjects'" (click)="switchView('subjects')">
        <span class="nav-icon">📚</span>
        <span>My Subjects</span>
      </a>
      <a class="nav-item" [class.active]="activeView === 'schedule'" (click)="switchView('schedule')">
        <span class="nav-icon">🕐</span>
        <span>Class Schedule</span>
      </a>
      <a class="nav-item logout-item" (click)="logout()">
        <span class="nav-icon">🚪</span>
        <span>Logout</span>
      </a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Header -->
    <header class="dashboard-header">
      <div class="header-left">
        <span class="header-icon">👨‍🎓</span>
        <h1>Welcome, {{ studentName }}!</h1>
        <div class="grade-selector" *ngIf="gradesList.length > 0">
          <button class="grade-btn" (click)="toggleGradeSelector()">
            <span class="grade-icon">📚</span>
            <span class="grade-text">
              {{ studentData?.gradeId ? getGradeName(studentData.gradeId) : 'Select Grade' }}
            </span>
            <span class="grade-arrow">▼</span>
          </button>
          
          <div *ngIf="showGradeSelector" class="grade-dropdown">
            <div class="grade-dropdown-header">
              <h4>Select Your Grade</h4>
              <button class="close-btn" (click)="toggleGradeSelector()">×</button>
            </div>
            <div class="grade-options">
              <label *ngFor="let grade of gradesList" class="grade-option">
                <input 
                  type="radio" 
                  name="grade" 
                  [value]="grade.gradeId"
                  [checked]="selectedGradeId == grade.gradeId"
                  (change)="onGradeChange(grade.gradeId)">
                <span class="grade-option-text">
                  <strong>{{ grade.gradeName }}</strong>
                  <small>{{ grade.description || 'Grade ' + grade.gradeLevel }}</small>
                </span>
              </label>
            </div>
            <div class="grade-dropdown-actions">
              <button class="btn-secondary" (click)="toggleGradeSelector()">Cancel</button>
              <button class="btn-primary" (click)="updateStudentGrade()" [disabled]="isLoading">
                <span *ngIf="!isLoading">Update Grade</span>
                <span *ngIf="isLoading">Updating...</span>
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="header-right">
        <div class="user-avatar">{{ studentName.charAt(0).toUpperCase() }}</div>
      </div>
    </header>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-state">
      Loading your dashboard...
    </div>

    <!-- Error Message -->
    <div *ngIf="errorMessage" class="error-alert">
      {{ errorMessage }}
    </div>

    <!-- Dashboard View -->
    <div *ngIf="!isLoading && activeView === 'dashboard'">
      <!-- Summary Cards -->
      <div class="summary-cards">
        <div class="summary-card academic-performance">
          <div class="card-content">
            <h3>Academic Performance</h3>
            <div class="card-stats">
              <div>
                <div class="stat-value">{{ overallAverage.toFixed(1) }}%</div>
                <div class="stat-label">Overall Average</div>
              </div>
              <span class="stat-icon">🎯</span>
            </div>
          </div>
        </div>

        <div class="summary-card attendance-summary">
          <div class="card-content">
            <h3>Attendance Rate</h3>
            <div class="card-stats">
              <div>
                <div class="stat-value">{{ attendanceRate.toFixed(1) }}%</div>
                <div class="stat-label">{{ presentCount }} / {{ totalAttendance }} Days</div>
              </div>
              <span class="stat-icon">✅</span>
            </div>
          </div>
        </div>

        <div class="summary-card tests-summary">
          <div class="card-content">
            <h3>Tests Completed</h3>
            <div class="card-stats">
              <div>
                <div class="stat-value">{{ completedTests }} / {{ totalTests }}</div>
                <div class="stat-label">{{ upcomingTests.length }} Upcoming</div>
              </div>
              <span class="stat-icon">📝</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Test Results -->
      <div class="content-section">
        <h2>Recent Test Results</h2>
        <div class="tests-grid">
          <div *ngFor="let test of testResults.slice(0, 4)" class="test-result-card">
            <div class="test-result-header">
              <span class="subject-badge">{{ test.subjectName }}</span>
              <span class="test-date">{{ formatDate(test.date) }}</span>
            </div>
            <h3>{{ test.testName }}</h3>
            <div class="score-display">
              <div class="score-circle" [class]="getPerformanceClass((test.marks / test.maxMarks) * 100)">
                <span class="score-value">{{ test.marks }}</span>
                <span class="score-divider">/</span>
                <span class="score-max">{{ test.maxMarks }}</span>
              </div>
              <div class="grade-badge" [class]="getGradeClass((test.marks / test.maxMarks) * 100)">
                {{ getGrade((test.marks / test.maxMarks) * 100) }}
              </div>
            </div>
            <div class="percentage-bar">
              <div class="percentage-fill" [class]="getPerformanceClass((test.marks / test.maxMarks) * 100)"
                   [style.width.%]="(test.marks / test.maxMarks) * 100">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Upcoming Tests -->
      <div class="content-section" *ngIf="upcomingTests.length > 0">
        <h2>Upcoming Tests</h2>
        <div class="upcoming-tests-list">
          <div *ngFor="let test of upcomingTests" class="upcoming-test-item">
            <div class="test-icon">📝</div>
            <div class="test-info">
              <h4>{{ test.testName }}</h4>
              <p>{{ test.subjectName }} • {{ test.testType }}</p>
            </div>
            <div class="test-date-info">
              <div class="days-until" [class.urgent]="getDaysUntilTest(test.date) <= 3">
                {{ getDaysUntilTest(test.date) }} days
              </div>
              <div class="test-date-small">{{ formatDate(test.date) }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Performance View -->
    <div *ngIf="!isLoading && activeView === 'performance'" class="content-view">
      <h2>Academic Performance</h2>
      <p>Track your performance across all subjects</p>

      <!-- Overall Stats -->
      <div class="performance-stats">
        <div class="stat-card-large primary">
          <div class="stat-icon-large">📊</div>
          <div class="stat-info-large">
            <div class="stat-number-large">{{ overallAverage.toFixed(1) }}%</div>
            <div class="stat-label-large">Overall Average</div>
          </div>
        </div>
        <div class="stat-card-large success">
          <div class="stat-icon-large">🏆</div>
          <div class="stat-info-large">
            <div class="stat-number-large">{{ gradeDistribution.A + gradeDistribution.B }}</div>
            <div class="stat-label-large">A & B Grades</div>
          </div>
        </div>
        <div class="stat-card-large info">
          <div class="stat-icon-large">📝</div>
          <div class="stat-info-large">
            <div class="stat-number-large">{{ completedTests }}</div>
            <div class="stat-label-large">Tests Completed</div>
          </div>
        </div>
      </div>

      <!-- Subject Performance -->
      <div class="subject-performance-section">
        <h3>Performance by Subject</h3>
        <div class="subject-performance-grid">
          <div *ngFor="let subject of subjectPerformance" class="subject-performance-card">
            <div class="subject-header">
              <h4>{{ subject.subjectName }}</h4>
              <span class="test-count-badge">{{ subject.testCount }} tests</span>
            </div>
            <div class="performance-circle" [class]="getPerformanceClass(subject.average)">
              <svg viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="45" class="circle-bg"></circle>
                <circle cx="50" cy="50" r="45" class="circle-progress"
                        [style.stroke-dashoffset]="283 - (283 * subject.average / 100)"></circle>
              </svg>
              <div class="performance-text">
                <span class="performance-percentage">{{ subject.average.toFixed(0) }}%</span>
                <span class="performance-grade">{{ getGrade(subject.average) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Grade Distribution -->
      <div class="grade-distribution-section">
        <h3>Grade Distribution</h3>
        <div class="grade-bars">
          <div class="grade-bar-item">
            <div class="grade-label">A (90-100%)</div>
            <div class="grade-bar">
              <div class="grade-bar-fill grade-a" 
                   [style.width.%]="completedTests > 0 ? (gradeDistribution.A / completedTests) * 100 : 0">
                {{ gradeDistribution.A }}
              </div>
            </div>
          </div>
          <div class="grade-bar-item">
            <div class="grade-label">B (80-89%)</div>
            <div class="grade-bar">
              <div class="grade-bar-fill grade-b" 
                   [style.width.%]="completedTests > 0 ? (gradeDistribution.B / completedTests) * 100 : 0">
                {{ gradeDistribution.B }}
              </div>
            </div>
          </div>
          <div class="grade-bar-item">
            <div class="grade-label">C (70-79%)</div>
            <div class="grade-bar">
              <div class="grade-bar-fill grade-c" 
                   [style.width.%]="completedTests > 0 ? (gradeDistribution.C / completedTests) * 100 : 0">
                {{ gradeDistribution.C }}
              </div>
            </div>
          </div>
          <div class="grade-bar-item">
            <div class="grade-label">D (60-69%)</div>
            <div class="grade-bar">
              <div class="grade-bar-fill grade-d" 
                   [style.width.%]="completedTests > 0 ? (gradeDistribution.D / completedTests) * 100 : 0">
                {{ gradeDistribution.D }}
              </div>
            </div>
          </div>
          <div class="grade-bar-item">
            <div class="grade-label">F (Below 60%)</div>
            <div class="grade-bar">
              <div class="grade-bar-fill grade-f" 
                   [style.width.%]="completedTests > 0 ? (gradeDistribution.F / completedTests) * 100 : 0">
                {{ gradeDistribution.F }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tests & Results View -->
    <div *ngIf="!isLoading && activeView === 'tests'" class="content-view">
      <h2>Tests & Results</h2>
      <p>View all your test results and upcoming assessments</p>

      <div class="results-table-container">
        <table class="results-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Subject</th>
              <th>Test Name</th>
              <th>Type</th>
              <th class="text-center">Score</th>
              <th class="text-center">Grade</th>
              <th class="text-center">Percentage</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let result of testResults">
              <td>{{ formatDate(result.date) }}</td>
              <td><strong>{{ result.subjectName }}</strong></td>
              <td>{{ result.testName }}</td>
              <td><span class="type-badge">{{ result.testType }}</span></td>
              <td class="text-center"><strong>{{ result.marks }}/{{ result.maxMarks }}</strong></td>
              <td class="text-center">
                <span class="grade-badge" [class]="getGradeClass((result.marks / result.maxMarks) * 100)">
                  {{ getGrade((result.marks / result.maxMarks) * 100) }}
                </span>
              </td>
              <td class="text-center">
                <div class="performance-bar-small">
                  <div class="performance-fill" [class]="getPerformanceClass((result.marks / result.maxMarks) * 100)"
                       [style.width.%]="(result.marks / result.maxMarks) * 100">
                    {{ ((result.marks / result.maxMarks) * 100).toFixed(0) }}%
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Attendance View -->
    <div *ngIf="!isLoading && activeView === 'attendance'" class="content-view">
      <h2>My Attendance</h2>
      <p>Track your attendance record</p>

      <!-- Attendance Stats -->
      <div class="attendance-stats-grid">
        <div class="stat-card present">
          <div class="stat-icon">✅</div>
          <div class="stat-info">
            <div class="stat-number">{{ presentCount }}</div>
            <div class="stat-label">Present</div>
          </div>
        </div>
        <div class="stat-card absent">
          <div class="stat-icon">❌</div>
          <div class="stat-info">
            <div class="stat-number">{{ absentCount }}</div>
            <div class="stat-label">Absent</div>
          </div>
        </div>
        <div class="stat-card late">
          <div class="stat-icon">⏰</div>
          <div class="stat-info">
            <div class="stat-number">{{ lateCount }}</div>
            <div class="stat-label">Late</div>
          </div>
        </div>
        <div class="stat-card total">
          <div class="stat-icon">📊</div>
          <div class="stat-info">
            <div class="stat-number">{{ attendanceRate.toFixed(0) }}%</div>
            <div class="stat-label">Attendance Rate</div>
          </div>
        </div>
      </div>

      <!-- Recent Attendance -->
      <div class="attendance-list-section">
        <h3>Recent Attendance (Last 30 Days)</h3>
        <div class="attendance-calendar">
          <div *ngFor="let record of attendanceRecords" class="attendance-day">
            <div class="day-date">{{ formatDate(record.date) }}</div>
            <div class="day-status" [class]="record.status.toLowerCase()">
              {{ record.status }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Subjects View -->
    <div *ngIf="!isLoading && activeView === 'subjects'" class="content-view">
      <h2>My Subjects</h2>
      <p>View all your enrolled subjects</p>

      <div class="subjects-grid">
        <div *ngFor="let subject of subjects" class="subject-card" 
             [class.academic]="subject.subjectType === 1" 
             [class.non-academic]="subject.subjectType === 2">
          <div class="card-header">
            <div class="subject-icon">
              {{ subject.subjectType === 1 ? '📚' : '🎨' }}
            </div>
            <span class="subject-type-badge" 
                  [class.academic]="subject.subjectType === 1"
                  [class.non-academic]="subject.subjectType === 2">
              {{ subject.subjectType === 1 ? 'Academic' : 'Non-Academic' }}
            </span>
          </div>
          <h3 class="subject-name">{{ subject.subjectName }}</h3>
        </div>
      </div>
    </div>

    <!-- Schedule View -->
    <div *ngIf="!isLoading && activeView === 'schedule'" class="content-view">
      <div class="placeholder-content">
        <p>📅</p>
        <p>Class Schedule</p>
        <p>Your class schedule will be displayed here.</p>
        <p style="color: #999; font-size: 14px;">This feature is coming soon!</p>
      </div>
    </div>
  </main>
</div>
